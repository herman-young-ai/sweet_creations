# Database Query Functions (`includes/functions.php`)

This file summarizes the PHP functions defined in `includes/functions.php` that interact directly with the database.

| Function Name                                         | Purpose                                                                            | Additional Comments                                                                                           |
|:----------------------------------------------------- |:---------------------------------------------------------------------------------- |:------------------------------------------------------------------------------------------------------------- |
| `connectDB()`                                         | Establishes a PDO connection to the database.                                      | Uses credentials defined in `config.php` (loaded from `.env`). Exits script on connection failure.            |
| `updateLastLogin($userId)`                            | Updates the `last_login` timestamp for a given user ID.                            | Called internally by `loginUser`.                                                                             |
| `loginUser($username, $password)`                     | Selects user data by username to verify login credentials.                         | Also calls `updateLastLogin` on success. Uses plain text password comparison (⚠️ Security Risk).              |
| `getAllCustomers(...)`                                | Fetches all customer records.                                                      | Allows optional sorting by column and direction.                                                              |
| `addCustomer($data)`                                  | Inserts a new record into the `CUSTOMERS` table.                                   | Returns the ID of the newly inserted customer or false on failure.                                            |
| `getCustomerById($id)`                                | Fetches a single complete customer record by its primary key (`customer_id`).      | Returns false if not found.                                                                                   |
| `updateCustomer($id, $data)`                          | Updates specified fields for an existing customer record.                          |                                                                                                               |
| `deleteCustomer($id)`                                 | Deletes a customer record *only* if they have no associated orders.                | First performs a `COUNT(*)` on the `ORDERS` table. Returns status string ('deleted', 'has_orders', 'error').  |
| `searchCustomers($searchTerm)`                        | Fetches customer records matching a term in name, phone, or email.                 | Uses `LIKE` comparison.                                                                                       |
| `getAllProducts(...)`                                 | Fetches all product records.                                                       | Allows optional sorting by column and direction.                                                              |
| `addProduct($data)`                                   | Inserts a new record into the `PRODUCTS` table.                                    | Returns the ID of the newly inserted product or false on failure.                                             |
| `getProductById($id)`                                 | Fetches a single complete product record by its primary key (`product_id`).        | Returns false if not found.                                                                                   |
| `updateProduct($id, $data)`                           | Updates specified fields for an existing product record.                           |                                                                                                               |
| `deleteProduct($id)`                                  | Deletes a product record *only* if it's not used in any `ORDER_ITEMS`.             | First performs a `COUNT(*)` on the `ORDER_ITEMS` table. Returns status string ('deleted', 'in_use', 'error'). |
| `getAllOrders(...)`                                   | Fetches all order records.                                                         | Optionally joins `CUSTOMERS` table to get `customer_name`. Allows sorting.                                    |
| `addOrderHeader($conn, $data)`                        | Inserts a new record into the `ORDERS` table (header only).                        | Assumes it's called within a transaction context (`PDO $conn` passed in).                                     |
| `addOrderItem($conn, $orderId, $itemData)`            | Inserts a new record into the `ORDER_ITEMS` table.                                 | Assumes it's called within a transaction context (`PDO $conn` passed in).                                     |
| `getOrderById($id)`                                   | Fetches a single order record, joining customer and user details.                  | Fetches `customer_name`, `customer_phone`, `customer_email`, `user_name`.                                     |
| `getOrderItems($orderId)`                             | Fetches all items associated with a specific order ID.                             | Joins `PRODUCTS` table to get `cake_name`.                                                                    |
| `updateOrder($orderId, $data)`                        | Updates main details (status, delivery info) of an existing order.                 | Dynamically builds the `SET` clause based on provided data keys. Does not update items or total amount.       |
| `getOrderCountForDate($date)`                         | Counts orders for a specific delivery date (excludes cancelled).                   | Used for dashboard widgets.                                                                                   |
| `getTotalCustomerCount()`                             | Counts the total number of customers.                                              | Used for dashboard widgets.                                                                                   |
| `getCurrentMonthIncome()`                             | Sums `total_amount` for orders placed in the current month (excludes cancelled).   | Used for dashboard widgets.                                                                                   |
| `getUpcomingOrders($limit)`                           | Fetches a limited number of future orders (excludes delivered/cancelled).          | Sorted by delivery date/time. Used for dashboard widget.                                                      |
| `getOrdersForDeliveryDate($date)`                     | Fetches full order details (including items) for a specific delivery date.         | Used for Daily Production report. Performs two queries (orders, then items). Excludes delivered/cancelled.    |
| `getOrdersForDeliveryDateRange($startDate, $endDate)` | Fetches orders within a delivery date range (excludes cancelled).                  | Used for Delivery Schedule report.                                                                            |
| `getMonthlySalesSummary($yearMonth)`                  | Gets total sales amount and order count for a specific month (excludes cancelled). | Used for Monthly Sales report.                                                                                |